File: repos/HL7_SLASH_fhir-exchange-routing-ig/input/pages/CapabilityStatement-exchange-routing-destination-server-intro.md

### FHIR Resource Content

When participating in exchanges described in the Hybrid / Intermediary FHIR IG, the destination server **SHALL** populate references to itself within FHIR resources it returns (e.g., in the Bundle.entry.fullUrl element) and in HTTP header parameters (e.g., Content-Location within the FHIR Asynchronous Pattern) with its public FHIR service base URL. 

<p></p>

### FHIR RESTful Capabilities

- Destination server **SHALL** support the JSON source format. 
- Destination server **SHOULD** support the XML source format. 

<p></p>

<h3>Security</h3>

- Communication security implemented by the server SHALL conform with the guidelines stated in [FHIR Security](https://www.hl7.org/fhir/security.html) for all exchanges covered in this IG.
- Destination server **MAY** implement the [HL7 / UDAP Security for Scalable Registration, Authentication, and Authorization FHIR Implementation Guide](http://hl7.org/fhir/us/udap-security/2021Sep/).
- For general security considerations refer to [FHIR Security and Privacy Considerations](https://www.hl7.org/fhir/secpriv-module.html). 

<br />



---

File: repos/HL7_SLASH_fhir-exchange-routing-ig/input/pages/CapabilityStatement-exchange-routing-intermediary-intro.md

### FHIR Resource Content

When participating in exchanges described in the Hybrid / Intermediary FHIR IG, the intermediary server **SHALL** pass FHIR resources returned by the destination server to the originator unchanged.

<p></p>

### FHIR RESTful Capabilities

- Intermediary server **SHALL** support the JSON source format. 
- Intermediary serer  **SHOULD** support the XML source format. 

<p></p>

<h3>Security</h3>

- Communication security implemented by the intermediary server **SHALL** conform with the guidelines stated in [FHIR Security](https://www.hl7.org/fhir/security.html) for all exchanges covered in this IG. 
- When using TLS: the inbound gateway intermediary **SHALL** hold the TLS certificate for the destination’s public FHIR service base URL the certificates exchanged by the destination system, and any delegated intermediaries **SHALL** reflect their servers’ private URLs.
- Intermediary server **SHALL** implement Transport Layer Security (TLS) for all exchanges covered in this IG.
- Security tokens generated and returned by the destination **SHALL** be forwarded by the intermediary server to the originating client. 
- Intermediary server **MAY** implement the [HL7 / UDAP Security for Scalable Registration, Authentication, and Authorization FHIR Implementation Guide](http://hl7.org/fhir/us/udap-security/2021Sep/).
- For general security considerations refer to [FHIR Security and Privacy Considerations](https://www.hl7.org/fhir/secpriv-module.html). 

<br />



---

File: repos/HL7_SLASH_fhir-exchange-routing-ig/input/pages/exceptions.md

After an originating system initiates an exchange, an exception could occur...

- at the destination service

  or 

- at an intermediary that is helping route the exchange.

This section describes a base set of conventions for reporting these exceptions. 

<p></p>

### Approach for conveying destination and intermediary exceptions

#### Destination-reported exceptions

Exception HTTP status codes generated by the destination are passed through unchanged by the intermediary to the originator.

<p></p>

#### Intermediary-reported exceptions

When an intermediary experiences an exception (including no HTTP response from a downstream actor) it SHALL:

- Stop the process of routing the request 
- Return the associated [HTTP status code](https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html)

  <p></p>

When an intermediary receives an exception reported by another intermediary or the destination, it SHALL pass the HTTP status code to the originator.

Note: This guide doesn't restrict parties from arranging for an intermediary to perform validation or other error detection on behalf of the destination. In that event: 
- either the intermediary or destination SHALL return an exception status code for each exception that occurs
- the intermediary MAY report errors it handles to the destination.

<p></p>

### Examples

<table class="grid">
  <thead>
    <tr>
      <th>Situation</th>
      <th style="min-width:150px">HTTP Status</th>
      <th>Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td colspan="3"><strong><em>Exceptions reported by an intermediary</em></strong></td>
    </tr>
    <tr>
      <td><b>Destination can’t be resolved</b></td>
      <td>404 Not Found</td>
      <td>Indicates that the destination could not be determined based on the submitted FHIR service base URL</td>
    </tr>
    <tr>
      <td><b>Attempt to connect to destination server timed out</b> (with no response)</td>
      <td>504 Gateway Timeout</td>
      <td>Indicates that a timeout occurred when trying to reach the destination server. Resource that the gateway was trying to connect to timed out</td>
      </tr>
    <tr>
      <td><b>System error</b></td>
      <td>500 Internal Error</td>
      <td>The server may not be able to generate an OperationOutcome in a system error situation</td>
    </tr>
    <tr>
      <td colspan="3"><strong><em>Exceptions reported by the destination</em></strong></td>     
    </tr>
    <tr>
      <td><b>Submitted URL path returned Page/Resource Not Found</b></td>
      <td>404 Not Found</td>
      <td>Generated by the destination, regardless of whether using direct connect or an intermediary. Intermediary passes through the status code and OperationOutcome if returned by the destination</td>
    </tr>
    <tr>
      <td><b>Invalid request</b> (e.g., bad query content)</td>
      <td>400 Bad Request</td>
      <td><i>as above</i></td>
    </tr>
    <tr>
      <td><b>System Error</b></td>
      <td>500 Internal Error</td>
      <td><i>as above</i></td>
    </tr>
  </tbody>
</table>


<p></p>

<br/>



---

File: repos/HL7_SLASH_fhir-exchange-routing-ig/input/pages/index.md

### Overview

The healthcare ecosystem is a complex one which includes many diverse types of actors including providers, health plans, government agencies, analytics and research, public health, and many others. This ecosystem historically and currently includes intermediaries, such as clearinghouses and health information exchanges, which broker communication and provide additional value-add services for those actors who choose to use them. Many actors have chosen to use intermediaries for the value-add services such as cloud scalability, technical outsourcing, security services, operational support, performance, resilience and protection from various attack vectors.

The purpose of this IG is not to introduce new intermediaries or mandate their use. Instead, the purpose is to recognize that intermediaries exist in healthcare and that to scale FHIR we need to account for them. This IG provides a unified model that supports both point-to-point interoperability without intermediaries and one in which one or more intermediaries exist. This model does not put any additional burden on the initiating actor to determine if an intermediary is present or not. The initiating actor’s request and standards-based interaction is the same in either scenario. Supporting the hybrid environment is key to the success of scaling FHIR across the ecosystem.

This implementation guide provides guidance for enabling FHIR REST interactions across one or more intermediaries using a passive approach. A passive approach is one in which the intermediary is ‘passing through’ the interaction and the requesting actor is not necessarily aware of the presence of the intermediary. Intermediaries in this context are organizations such as clearinghouses, health information exchanges, and similar entities.  We recognize that there are ‘active’ intermediary use cases (TEF QHIN, aggregation services, record locator, etc.) which will be handled in future IGs.

The guide supports exchanges where the client and destination FHIR server interact with the same steps, content and responsibilities as in a direct connection--while enabling the destination to "sit behind" an intermediary that can provide value-add services such as cloud-scale technical infrastructure, support services, denial of service protection, and business/operational onboarding.

This version of the IG uses a pattern similar to that of a reverse proxy, where the intermediary server is positioned in front of one or more destination FHIR web servers, brokering requests from originating systems and forwarding them to the appropriate destinations. Future versions of the IG may expand with additional characteristics beyond that pattern.

- Example actors for the initial IG include organizations such clinics, providers, hospitals, payers, etc. These actors may be originators of a RESTful request or the destination system for the request.
- Example intermediaries for the initial IG include organizations such as clearinghouses (i.e., Change, Availity) and HIEs ( i.e., eHealth Exchange).

<p></p>

Potential applications of this initial IG include use by implementers of payer/provider use cases such as the _Da Vinci value-based care_ use case in which intermediaries may bridge connectivity between actors. Other HL7 accelerators (CARIN, Gravity, etc.) are developing disparate actor use cases in which intermediaries may be involved.

The community recognizes that direct point-to-point RESTful interaction is a primary interaction pattern. However, we also recognize that intermediaries play important roles for some healthcare actors and having a set of best practices so that we don’t put additional burdens on the client actors is key to running FHIR at scale. This is called the ‘hybrid’ model approach and this IG documents a set of best practices to enable connectivity both in point-to-point and intermediary-facilitated exchange without the client actor needing to have knowledge of what model is executing.

<p></p>

### Background

As the range of healthcare actors using FHIR has grown, so has the need to route exchanges across intermediaries such as clearinghouses, HIEs, national networks, and others. An example of this scenario is the situation in which a payer uses a clearinghouse intermediary as their 'gateway' for receiving FHIR requests. 

Stakeholders use intermediaries for technical, operational and business reasons. The intermediary model was adopted by many payer and provider systems with the original X12 transaction set and is expected to continue as FHIR REST API integration evolves. Other networks, including HIEs and national networks, have emerged as brokering intermediaries for document access/exchange, e-prescribing and other purposes, and may also engage in FHIR-based interoperability.

This implementation guide defines conventions for certain classes of FHIR exchanges that involve such intermediaries. It establishes a basic foundation that will be enhanced and built on over time as stakeholders encounter additional needs.

<p></p>

### Scope of This Guide

**In scope**

The implementation guide focuses on exchanges where...

- the originating system may be unaware that its request will be routed through an intermediary to the final destination for processing; from the perspective of the originating system its intended destination is the responding system

  and

- an intermediary accepts the request on the destination's behalf and then routes it--directly or through another intermediary--to the destination's system

  and

- the originator and destination have established trust, with participating intermediaries passively conveying resulting tokens or other security artifacts

The guide aims to support all RESTful FHIR interaction types (GET, POST, etc.) within this set of scenarios.

This implementation guide was initially created for US Realm but is certainly open to use anywhere it provides value.

<p></p>

**Out of scope of this version of the guide**

The guide does not address all intermediary exchange scenarios that exist today, and does not aim to support emerging network needs such as those posed by the Trusted Exchange Framework and Common Agreement (TEFCA). Environments and use cases supported by active intermediaries are recognized as valid, but are not the focus of the initial version of this guide.

Excluded from scope are environments or scenarios where:

- trust is not negotiated between the originating client and the destination. For example, scenarios where the client establishes trust with an intermediary instead of the destination are not supported
- the originating client addresses requests to anything but the destination’s public URL (for example, instead submitting to a different, network-assigned URL representing the destination)
- the destination does not respond using its public FHIR service base URL in elements that reference the destination's server within returned FHIR resources (for example, populating elements such as fullUrl with a non-public system URL which would require URL rewriting)
- one or more intermediaries rewrite URLs representing the destination server in returned FHIR resources.

In addition, this guide does not provide guidance for the use of [FHIR Messaging](https://www.hl7.org/fhir/messaging.html), which also includes routing features that can be used to exchange message content through intermediaries.

<p></p>

The guide may be expanded to cover additional environments and scenarios in the future. 

<p></p>

### Solution Features

- Common mechanisms used for many years in healthcare and other industries
- Lightweight
- Works when performing all REST interactions including GET (e.g., for a search or retrieval) ensuring that the intermediary routing can be accomplished even if no FHIR resource is being submitted
- Universally usable, regardless of FHIR content. Resource-type agnostic
- Requires no special handling by the originator; the originating system is unaware that an intermediary will play a role in routing the request

<p></p>

### Content and Organization

The guide is organized into the following sections:

- [Use Cases and Roles](use-cases.html) gives an overview of the guide's goals and participants.
- [Exception Handling](exceptions.html) describes expectations for conveying destination-reported exceptions as well as those detected by an intermediary.
- [Security](security.html) identifies aspects needed to support the IG's flows and addtional guidance defined elsewhere.
- [Specification](specification.html) describes the solution in detail.

<p></p>

### Authors

  <table class="grid">
    <tbody>
	  <tr>
		<td colspan="2">HL7 FHIR Infrastructure Workgroup</td>
  	  </tr>
	  <tr>
		<td colspan="2">ONC FHIR at Scale Taskforce (FAST) - Exchange Tiger Team</td>
  	  </tr>
	  <tr>
		<td>Patrick Murta</td>
		<td><a href="mailto:PatrickMurta@behavr.com">PatrickMurta@behavr.com</a></td>
	  </tr>
	  <tr>
		<td>Frank McKinney</td>
		<td><a href="mailto:frank.mckinney@pocp.com">frank.mckinney@pocp.com</a></td>
	  </tr>
	</tbody>
  </table>



<br /><br />

















---

File: repos/HL7_SLASH_fhir-exchange-routing-ig/input/pages/security.md

Note: This section contains conformance requirements, noted with "SHALL", "SHOULD" and "MAY".
<p></p>

### Pass-Through Security
The Pass-Through Security approach defines the interaction between the initiator and the destination, with minimal involvement of the intermediary. As described below, it supports this implementation guide’s passive intermediary model. It may also be suitable for other models where the intermediary plays a more active role in serving or modifying the returned content. 
- Note: Additional security models may be defined in future versions of this IG as needed to support expanded intermediary roles

#### Transport Security

Communication security SHALL conform with the guidelines stated in [FHIR Security](https://www.hl7.org/fhir/security.html).

When using TLS:
- the inbound gateway intermediary SHALL hold the TLS certificate for the destination’s public FHIR service base URL
- the certificates exchanged by the destination system and any delegated intermediaries SHALL reflect their servers’ private URLs.


<p></p>

#### Trust Determination

In this exchange model, trust is negotiated or established solely between the originator and destination. The destination SHALL determine whether it trusts the originator or not; any intermediaries involved in the exchange SHALL play a passive, "pass through" role in the process.

Required behavior:

- security tokens generated by the destination for use by the originator SHALL be forwarded by any intermediaries to the originating client.

Implementers MAY adopt UDAP workflows for client registration, authentication and authorization as described in the [HL7 / UDAP Security for Scalable Registration, Authentication, and Authorization FHIR Implementation Guide](http://hl7.org/fhir/us/udap-security) 

<p></p>

### Other Security and Privacy Considerations

Implementers of this guide SHOULD follow core FHIR security principles and protect patient privacy as described in the [FHIR Security and Privacy Module](https://www.hl7.org/fhir/secpriv-module.html) which:
  -  provides guidance related to communication security, authentication, authorization/access control, audit, digital signatures, attachments, labels, narrative, and input validation. 
  -  describes how to protect a FHIR server through access control and authorization, how to document what permissions a user has granted, and how to keep records about what events have been performed.

The FHIR security specification is available [here](https://www.hl7.org/fhir/security.html).

<br><br>





---

File: repos/HL7_SLASH_fhir-exchange-routing-ig/input/pages/specification.md

This section further describes details of the scenarios introduced in the [Use Cases and Roles](use-cases.html) section, and specifies approaches for "addressing" exchanges between the originating system, participating intermediaries and the ultimate destination system. 

<p></p>

### Assumptions: Partnership and setup between the destination and intermediaries

This guide assumes that the destination and intermediary participants have established business arrangements, if required, and performed configuration activities, if required, prior to processing requests. These SHALL include the following, but MAY include the setup of additional value-add services performed by the intermediary participants.

- An intermediary, functioning as an inbound gateway, SHALL agree to accept FHIR requests on the destination's behalf
- The destination and inbound gateway intermediary SHALL establish the destination's public FHIR service base URL [(details below)](#destinations-public-fhir-service-base-url) according to their preferences
- One or more additional delegated intermediaries MAY optionally agree to participate in the routing of requests between the inbound gateway intermediary and the destination
- Each participating intermediary SHALL configure its internal routing mechanisms to enable forwarding of requests to either the destination system or another participating intermediary, as prearranged among the parties. 
  - Note: This guide does not prescribe particular routing logic or technical approaches to be used by an intermediary to other intermediaries or the destination
- One or more public endpoint directories MAY be configured to support searching for the destination and return of the destination's public FHIR service URL 

<p></p>

### FHIR service base URLs 

#### Destination's public FHIR service base URL

The destination SHALL have a single public FHIR service base URL for each for each logical FHIR server it makes available using the passive intermediary routing approach described in this guide.

The partnering destination and inbound gateway intermediary are free to determine the appropriate structure of the public FHIR service base URL to meet their preferences and technical requirements. For example, the URL's hostname may refer to either the destination or the intermediary and path segments may be included to identify the destination, specify the supported FHIR version, etc. In addition, the destination SHALL  [reference its public URL in returned FHIR resources](#references-to-the-service-base-url-in-returned-fhir-resources).

<p></p>


Example approaches:

- *Intermediary's base URL followed by a path indicating the destination,* such as `fhir.example-intermediary.com/example-destination`. In this method, the destination's public FHIR service URL consists of a base URL reflecting the inbound gateway Intermediary's identity followed by a path segment following the base that reflects the destination's identity. The intermediary may then base routing on the path segment that indicates the destination.
- *Base URL that reflects the destination's identity,* such as`fhir.example-destination.com`. In this method, the destination uses a public FHIR service base URL that reflects its own identity and, in turn, hides participation of the inbound gateway Intermediary it employs. The intermediary bases routing on the network IP address at which it receives the request (the IP to which the public URL's DNS record is mapped).
- *Subdomain of intermediary's URL that identifies the destination,* such as `example-destination.example-intermediary.com`. In this method, the destination is represented using a subdomain of the inbound gateway Intermediary's URL. The intermediary bases routing on the network IP address to which the subdomain's DNS record is mapped.

Regardless of the URL structure used as the public URL, it SHALL be a valid [FHIR service base URL](https://www.hl7.org/fhir/http.html#root) that originators can use without knowledge of its individual components--as they do any other FHIR service URL

<p></p>

**Considerations**
<br><br>
While this guide does not prescribe a particular structure for the public FHIR service base URL used in these exchanges, implementers might consider the factors below when deciding their URL approach:

Use of a public URL containing the intermediary's hostname, for example `fhir.intermediary1.com/myorg`, provides human-recognizable context about the intermediary relationship, independent of the technical resolution of the URL. While this does not necessarily reflect a technical constraint to changing intermediaries, use of a public URL containing the intermediary's hostname may make it more difficult for the destination to change the intermediary as it may result in a change to its public URL. 

More critically, any change to the destination's public URL–whether due to a change in intermediary or other reason--would impact originators using the original URL, creating a responsibility for the destination, intermediary or other party to make originators aware that the URL has changed so that they can start using the new one.

Preferably, URL naming will accommodate changes to actors involved in the exchange or relationships between them, to avoid impacting originators.

<p></p><p></p>
<div>
   <figure>
    <figcaption class="figure-caption"><strong>Figure 2: FHIR Service URLs</strong></figcaption>
    <img src="one-int-routing.png" style="float:none; width:1000px" title="Figure 2: FHIR Service URLs"/>  
    </figure>
</div>

\* Figure notes:
- The illustration reflects CNAME mapping of `bcorp.int-one.net`, `fhir.int-one.net` and `fhir.d-corp.com` to the intermediary's server, `int-one.net`
- Canonical Name (CNAME) records are managed at the registrar that maintains the associated domain name (e.g., `fhir.d-corp.com` is managed at `d-corp.com`'s registrar and `bcorp.int-one.net` is managed at `int-one.net`'s registrar)
<p></p>
<p></p>

#### FHIR service base URLs used in routing between intermediaries and to the actual destination server

The destination and each delegated intermediary (participating in exchange hops following the inbound gateway intermediary) defines the URL at which it accepts requests intended for the destination.  Each party is free to determine the appropriate structure of the URL to meet its preferences and technical requirements, as described in the preceding section.

This guide does not prescribe a particular URL structure to be used; however, it SHALL: 

- be a valid [FHIR service base URL](https://www.hl7.org/fhir/http.html#root) 
- be a unique URL associated only with the destination.

_Note: Handling when an HIE plays the role of an aggregator._ In the case where the HIE is the entity serving the FHIR resources (acting as an aggregator that stores/serves the resources to the originator, and there is no visibility to the source systems), the HIE is considered the destination, the public URL is that of the HIE, and the source entities would not be visible in the exchange

#### Sharing of URLs among the destination and partner intermediaries

"Private" FHIR service base URLs are shared between participating parties as needed to facilitate routing during the exchange. This guide does not assume that a participant will be aware of the URLs used by all "hops" in the exchange, but only its own URL and that of the next participant to which it forwards a request.

#### References to the service base URL in returned FHIR resources

References to the destination's server in FHIR resources that it produces SHALL equal the destination's single public FHIR service base address.  

For example, the Bundle.entry.fullUrl element for a resource on the destination's server SHALL contain the same FHIR service base address as the destination would publish in a public endpoint directory.  

<p></p>

### Trust Between Participants 

#### The originating client negotiates trust with the destination

In the passive intermediary exchange model, trust has been established or is negotiated solely between the originator and destination. It is the destination which makes the decision as to whether it trusts the originator or not; any intermediaries involved in the exchange play a passive, "pass through" role in the process using the [Pass-Through Security model](security.html#pass-through-security) described in the Security section of the IG.

<p></p>

<div>
   <figure>
    <figcaption class="figure-caption"><strong>Figure 3: Trust Overview</strong></figcaption>
    <img src="one-int-trust.png" style="float:none; width:1000px" title="Figure 3: Trust Overview"/>  
  </figure>
</div>
<p></p>

<p></p>

#### Trust and routing overview - multiple intermediaries

The required behavior described above for single-intermediary scenarios apply equally when one or more additional intermediaries participate in the exchange, as illustrated below.

<div>
   <figure>
    <figcaption class="figure-caption"><strong>Figure 4: Mutliple Intermediary Overview</strong></figcaption>
    <img src="multi-int-overview.png" style="float:none; width:1000px" title="Figure 4: Multiple Intermediary Overview">  
   </figure>
</div>
<p></p>

### Sharing additional routing information between intermediary and destination
Because the intermediary role described here is similar to that of a reverse proxy, intermediaries may employ additional HTTP header field standards to convey additional routing information to the destination--such as the originator’s IP address and the Host request header field received in the request from the originator to the intermediary.

While the intermediary responsibilities described in this IG do not require it, sharing of this additional routing information may benefit a destination server that wishes to support additional features beyond the scope of this guide. When that is the case, implementers may reference these IETF standards:

- [IETF rfc7239 - Forwarded HTTP Extension](https://datatracker.ietf.org/doc/html/rfc7239)

- [IETF rfc2068 – HTTP 1.1 ("Host" and "Via" headers)](https://www.ietf.org/rfc/rfc2068.txt)
<p></p>
<p></p>

### Unsupported Scenarios
<p></p>
Based on the rules and constraints described above, the following underscores scenarios that are not in scope of this implementation guide.

<div>
   <figure>
    <figcaption class="figure-caption"><strong>Figure 5: Unsupported Scenario Overview</strong></figcaption>
    <img src="not-supported.png" style="float:none; width:1000px" title="Figure 5: Unsupported Scenario Overview"/>  
   </figure>
</div>
<p></p>

<p></p>

### Synchronous Scenarios

<p></p>

#### Scenario: Request routed through a single inbound gateway intermediary 

This scenario supports a situation where the destination delegates the responsibility of securing a public endpoint--and potentially performing other functions such as registering clients--to an intermediary. A single intermediary participates in this exchange, forwarding requests directly from the originator to the destination.

Below is the main flow of this scenario.

**Step 1. Originator obtains the destination's public FHIR service address**

Before the exchange, the originator system obtains the destination's public FHIR service address, for example through a reference in a previously-received FHIR resource or by consulting an endpoint directory. 

**Step 2. Originator initiates a RESTful interaction using the destination's public FHIR service address**

The originator system then initiates a RESTful exchange (for example, a GET method to retrieve a FHIR resource) that is transmitted to the destination's public FHIR service address. 

**Step 3. The exchange is received by the inbound gateway intermediary through resolution of the public FHIR service base URL**

The intermediary receives the request on behalf of the destination. The URL resolves to a destination-specific location at the intermediary.

**Step 4. The intermediary routes the exchange to the destination**

The intermediary determines where to route the exchange based on its arrangement with the destination owner. 

Because the destination's public URL resolves to a destination-specific location at the intermediary--the intermediary can recognize the intended receiver and determine the correct routing to that destination. 

**Step 5. The destination processes the request and returns its response to the intermediary**

The destination processes the request and synchronously returns its response. 

_**Note - conformance requirement:**_ Any references to the destination's FHIR service in resources that are returned by the destination--for example, in a search result Bundle's fullUrl element--**SHALL** be populated by the destination server to match the public FHIR service address used by the originator.

**Step 6. The intermediary passes through the response to the originator**

The intermediary, which is holding a synchronous connection with the originator, passes through the response. 

**Step 7. The originator receives the response**

The originator accepts the response. If it wishes to submit a follow-on request using a reference in a received resource, it interprets the reference as typically does, without any adjustments caused by the initial request having been routed through an intermediary. This is possible because the destination uses its public FHIR address as the FHIR service base value in elements such as Bundle.fullUrl.  

<p></p>

<div>
   <figure>
    <figcaption class="figure-caption"><strong>Figure 6: Example - Intermediary's Base URL followed by a path indicating the destination</strong></figcaption>
    <img src="uc-search-single-intermediary-int-url-plus-segment.png" style="float:none; width:1100px" title="Example - Intermediary's Base URL followed by a path indicating the destination"/>  
  </figure>
</div>
<p></p>

#### Scenario: Destination uses an inbound gateway Intermediary that in turn routes through another intermediary to deliver the exchange

This scenario supports a situation where one or more additional "delegated" intermediaries--beyond the inbound gateway with with the originator directly interacts--is used to deliver a request to its ultimate destination. 

Below is the main flow of this scenario. The initial steps in this scenario are the same as in the one-intermediary scenario above.

**Step 1. Originator obtains the destination's public FHIR service address**

Before the exchange, the originator system obtains the destination’s public FHIR service address, for example through a reference in a previously-received FHIR resource or by consulting an endpoint directory.

**Step 2. Originator initiates a RESTful interaction using the destination's public FHIR service address**

The originator system then initiates a RESTful exchange (for example, a GET method to retrieve a FHIR resource) that is transmitted to the destination’s public FHIR service address.

**Step 3. The exchange is received by the inbound gateway intermediary through resolution of the public FHIR service base URL**

The originator submits its request to the public FHIR service address for the destination, and the public FHIR service base URL resolves to the inbound gateway intermediary to be routed onward.

**Step 4. The inbound gateway intermediary routes the exchange to a second intermediary**

The intermediary forwards the exchange to a second "delegated" intermediary who will forward it on toward the destination organization. 

This determination is based on arrangements previously established between this intermediary, the destination owner and/or participating intermediaries.

*Note: This implementation guide does not prescribe the nature of such arrangements nor the manner by which intermediaries discover or represent them within their systems.*

**Step 5. The second intermediary routes the exchange to the destination endpoint**

Based on routing metadata conveyed to it in the URL path or via HTTP headers, the second intermediary determines where to route the exchange based on its arrangement with the inbound gateway intermediary and/or the destination owner. 

**Step 6. The destination processes the request and returns its response to the intermediary**

The destination processes the request and synchronously returns its response. 

_**Note - conformance requirement:**_ Note that any references to the destination's FHIR service in resources that are returned by the destination--for example, in a search result Bundle's fullUrl element--**SHALL** be populated by the destination server to match the public FHIR service address used by the originator.

**Step 7. The second intermediary passes through the response to the inbound gateway intermediary**

The intermediary, which is holding a synchronous connection with the originator, passes through the response

**Step 8. The inbound gateway intermediary passes through the response to the originator**

The intermediary, which is holding a synchronous connection with the originator, passes through the response. 

**Step 9. The originator receives the response**

The originator accepts the response. If it wishes to submit a follow-on request using a reference in a received resource, it interprets the reference as typically does, without any adjustments caused by the initial request having been routed through an intermediary. This is possible because the destination uses its public FHIR address as the FHIR service base value in elements such as Bundle.fullUrl.  

<p></p>

<div>
   <figure>
    <figcaption class="figure-caption"><strong>Figure 7: Example - Intermediary's Base URL followed by a path indicating the destination</strong></figcaption>
    <img src="uc-search-two-intermediaries-int-url-plus-segment.png" style="float:none; width:1100px" title="Figure 7: Example - Intermediary's Base URL followed by a path indicating the destination"/>  
  </figure>  
</div>
<p></p>

<p></p><hr><p></p>

### Asynchronous Scenario

<p></p>
Note: While the section below describes a GET request of information, all methods described in [FHIR Asynchronous Pattern](https://www.hl7.org/fhir/async.html) including Bulk Data Delete Request are supported by this IG.

#### Scenario: Originator initiates an asynchronous retrieval of data from a Destination that uses an inbound gateway Intermediary

In this scenario, the originator uses the [FHIR Asynchronous Pattern](https://www.hl7.org/fhir/async.html) to retrieve data from a destination that uses an inbound gateway intermediary as described above. 

Below is the main flow of this scenario.

**Step 1. Originator obtains the destination's public FHIR service address**

Before the exchange, the originator system obtains the destination’s public FHIR service address, for example through a reference in a previously-received FHIR resource or by consulting an endpoint directory.

**Step 2. Originator initiates a RESTful interaction using the destination's public FHIR service address**

In this scenario, the originator populates the `Prefer` HTTP header with `respond-async` to notify the destination that it want to obtain the response data asynchronously.

**Step 3. The exchange is received by the inbound gateway intermediary through resolution of the public FHIR service base URL**

The originator submits its request to the public FHIR service address for the destination, and the public FHIR service base URL resolves to the inbound gateway intermediary to be routed onward.

**Step 4. The intermediary routes the exchange to the destination**

The `Prefer: respond-async` header is also forwarded to the destination.

**Step 5. The destination processes the request and returns its response to the intermediary**

The destination processes the request and returns the location to poll for status to the intermediary. The destination responds with an HTTP status code of `202 Accepted`, and an HTTP header containing a `Content-Location` parameter that specifies the URL at which status of the request will be available

**Step 7. The intermediary passes through the response to the originator**

The intermediary, which is holding a synchronous connection with the originator, passes through the response. 

**Step 7. The originator polls for status**

The originator polls for status until the server responds with a "completed" HTTP status code `200 OK` and body containing one or more URLs at which to retrieve the response data. 
Note: The returned content location URL(s) may contain the public FHIR service base URL used to initiate the asynchronous exchange process--so that retrieval of the content also flows through the intermediary--but that is not required.

**Step 8. The intermediary routes the status request to the destination**
The intermediary forwards the request to the destination.

**Step 9. The intermediary passes through the status response to the originator**

The intermediary, which is holding a synchronous connection with the originator, passes through the response.

**Step 10. The originator retrieves the response data**

The originator retrieves the requested data using the URL(s) returned in the completed status response from the destination. This request and response are routed as described in Steps 1-7, except that the `Prefer: respond-async` parameter is not used.

<p></p>

<div>
   <figure>
    <figcaption class="figure-caption"><strong>Figure 8: Example - Intermediary's Base URL followed by a path indicating the destination</strong></figcaption>
    <img src="uc-async-single-intermediary-int-url-plus-segment.png" style="float:none; width:1100px" title="Figure 8: Example - Intermediary's Base URL followed by a path indicating the destination"/>  
  </figure>
</div>
<br>

---

File: repos/HL7_SLASH_fhir-exchange-routing-ig/input/pages/use-cases.md

This guide supports scenarios where intermediaries take part in RESTful FHIR exchanges between an initiating system (the "originator") and the desired endpoint system (the "destination").  

Potential applications of this initial IG include use by implementers of payer/provider use cases such as Da Vinci value-based care use case in which intermediaries may bridge connectivity between actors. Other HL7 accelerators (CARIN, Gravity, etc.) are developing disparate actor use cases in which intermediaries may be involved.

Specifically, it focuses on scenarios where:

- the originator directs the exchange to the destination's public FHIR service base URL, for example as retrieved from an endpoint directory

- but the destination has an arrangement where an intermediary accepts the request on the destination's behalf and then routes it to the destination's system -- either directly or through another intermediary.

This page defines the roles that intermediaries play in the scenarios addressed in this guide and then describes those scenarios more fully.

<p></p>

### Intermediary Capability Roles

<table class="grid">
  <thead>
    <tr>
      <th>Intermediary  Role</th>
      <th>Description</th>
      <th>Benefit provided</th>
      <th>Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td colspan="4"><strong><em>Supported in this guide:</em></strong></td>
    </tr>
    <tr>
      <td>Inbound  Gateway</td>
      <td>This intermediary role receives requests intended for the destination and  forwards them to the destination system or another intermediary</td>
      <td>The inbound gateway assumes the responsibility of establishing transport security with submitters to the public URL and potentially performing other work on behalf of the destination such as cloud-scale infrastructure, technical support, business/operational onboarding and support, actor agnosticism, and attack protection such as denial of service.</td>
      <td>Public DNS entries are used to “point” the destination’s public URL to this intermediary
        </td>
    </tr>
    <tr>
      <td>Delegated  Intermediary</td>
      <td>This intermediary role assists in routing from a different intermediary to the destination system</td>
      <td>This intermediary may serve as a public network to which the destination system is connected</td>
      <td>Intermediaries share non-public routing information to pre-arrange for delivery to the ultimate destination</td>
    </tr>
  </tbody>
</table>





<p></p>

### Scenario Overview

While there are many potential exchange scenarios in which an intermediary could play a part, this guide focuses on a specific set where:

- the exchange is a RESTful FHIR interaction or complementary approach such as CDS hooks
- an intermediary plays the **inbound gateway** role described above, accepting requests from the originator
- one or more additional intermediaries optionally play the **delegated function Intermediary** role described above, assisting in routing to the destination
- the originator directs its request to the destination’s public FHIR service URL, and the destination likewise uses that public FHIR service URL when referring to itself in the response (the destination populates elements referencing the destination server in returned FHIR resources, e.g., fullUrl, using the pubic FHIR service base URL)
- trust has been established or is negotiated between the originating client and the destination; any participating intermediaries play only a pass-through role in authentication and authorization (see [Pass-Through Security](security.html#pass-through-security))
- the originator may be unaware that an intermediary will play a role in routing the request, and has no additional responsibilities beyond those in a typical point-to-point FHIR exchange.

<p></p>
<div>
   <figure>
    <figcaption class="figure-caption"><strong>Figure 1: High-level Exchange Overview</strong></figcaption>
    <img src="supported.png" style="float:none; width:1000px" title="Figure 1: High-level Exchange Overview"/> 
  </figure>
</div>
<p></p>


### Excluded scenarios

This implementation guide does not support environments or scenarios where:

- trust is not negotiated between the originating client and the destination. For example, scenarios where the client establishes trust with an intermediary instead of the destination are not supported
- the originating client addresses requests to anything but the destination’s public URL (for example, instead submitting to a different, network-assigned URL representing the destination)
- the destination does not respond using its pubic FHIR service base URL in elements that reference the destination's server within returned FHIR resources (for example, populating elements such as fullUrl with a non-public system URL)
- one or more intermediaries rewrite URLs representing the destination server in returned FHIR resources.

In addition, this guide does not provide guidance for the use of [FHIR Messaging](https://www.hl7.org/fhir/messaging.html), which also includes routing features that can be used to exchange message content through intermediaries.

<p></p>



### Assumptions: Participant Agreements and Setup Steps

This guide assumes that the destination and intermediary participants have established business arrangements and performed the following configuration steps prior to processing requests:

- The destination arranges for an inbound gateway intermediary to accept FHIR requests on its behalf
- The destination and inbound gateway intermediary establish the destination's public FHIR service base URL. The parties determine the structure of the URL to meet their preferences and technical requirements. For example, the URL's hostname may refer to either the destination or the intermediary and path segments may be included to identify the destination, specify the supported FHIR version, etc.
  - This guide does not prescribe a particular URL structure to be used; it can be any valid [FHIR service base URL](https://www.hl7.org/fhir/http.html#root) that originators can use without knowledge of its individual components--as they do any other FHIR service URL
- The intermediary or destination configures its public FHIR service base URL so that requests resolve to the inbound gateway intermediary
- Participants share private server addresses as needed and pre-configure internal routing mechanisms to support forwarding through any delegated intermediaries and ultimately delivery to the destination system
  - This guide does not prescribe particular routing logic or technical approaches to be used by the intermediary
- (Optional) One or more public endpoint directories are configured to support searching for the destination and return of the destination's public FHIR service URL 

<p></p>

Scenarios are separated into two groups below:

- **synchronous** exchanges, in which participating intermediaries stay connected until the destination's response is forwarded to the originator
  - Scenario: [Request routed through a single inbound gateway intermediary](#request-routed-through-a-single-inbound-gateway-intermediary)
  - Scenario: [Destination uses an inbound gateway intermediary that, in turn routes to another intermediary to deliver the exchange](#destination-uses-an-inbound-gateway-intermediary-that-in-turn-routes-to-another-intermediary-to-deliver-the-exchange)
- **asynchronous** exchanges that follow the [FHIR Asynchronous Request pattern](http://hl7.org/fhir/async.html), as used in the [Bulk Data Access IG](https://hl7.org/fhir/uv/bulkdata/index.html)
  - Scenario: [Originator initiates an asynchronous retrieval of data from a Destination that uses an inbound gateway Intermediary](#originator-initiates-an-asynchronous-retrieval-of-data-from-a-destination-that-uses-an-inbound-gateway-intermediary)

<p></p>

### Synchronous Scenarios

<p></p>

#### Request routed through a single inbound gateway intermediary 

This scenario supports a situation where the destination delegates the responsibility of securing a public endpoint--and potentially performing other functions such as registering clients--to an intermediary. A single intermediary participates in this exchange, forwarding requests directly from the originator to the destination. The destination processes the request and synchronously returns its response.

- The originator obtains the destination's public FHIR service base URL, for example from a FHIR endpoint directory

- The originator initiates a RESTful interaction using the destination's public FHIR service base URL

- The exchange is received by the inbound gateway intermediary through resolution of the public FHIR service base URL

- The intermediary routes the exchange to the destination

- The destination processes the request and returns its response to the intermediary, populating any references to the destination's FHIR server address using its public FHIR service base URL 

- The intermediary passes through the response to the originator

- The originator receives the response

*[Exchange flows and additional details](specification.html#scenario-request-routed-through-a-single-inbound-gateway-intermediary)*

<p></p>

#### Destination uses an inbound gateway intermediary that in turn routes to another intermediary to deliver the exchange

This scenario supports a situation where one or more intermediaries participate in delivering the exchange to the destination system. 

Steps
- Originator obtains the destination's public FHIR service address
- Originator initiates a RESTful interaction using the destination's public FHIR service address
- The exchange is received by the inbound gateway intermediary through resolution of the public FHIR service base URL
- The inbound gateway intermediary routes the exchange to a second intermediary. Based on its arrangement with the destination owner or other intermediary(ies), the inbound gateway intermediary determines that the exchange must be directed to a different intermediary for delivery to the endpoint used by the destination organization
- The delegated intermediary routes the exchange to the destination endpoint. (Optionally, one or more intermediaries may also participate in the exchange prior to delivery to the destination)
- The destination processes the request and returns its response to the last intermediary
- The delegated intermediary passes through the response to the inbound gateway intermediary
- The inbound gateway intermediary, which is holding a synchronous connection with the originator, passes through the response
- The originator receives the response

*[Exchange flows and additional details](specification.html#scenario-destination-uses-an-inbound-gateway-intermediary-that-in-turn-routes-through-another-intermediary-to-deliver-the-exchange)*

<p></p>

### Asynchronous Scenario

#### Originator initiates an asynchronous retrieval of data from a Destination that uses an inbound gateway Intermediary

In this scenario, the originator uses the [FHIR Asynchronous Pattern](https://www.hl7.org/fhir/async.html) to retrieve data from a destination that uses an inbound gateway intermediary as described above. 

Steps
- Originator obtains the destination's public FHIR service address
- Originator initiates a RESTful interaction using the destination's public FHIR service address. In this scenario, the originator populates the `Prefer` HTTP header with `respond-async` to notify the destination that it want to obtain the response data asynchronously
- The exchange is received by the inbound gateway intermediary through resolution of the public FHIR service base URL
- The intermediary routes the exchange to the destination. The `Prefer: respond-async` header is also forwarded to the destination
- The destination processes the request and returns the location to poll for status to the intermediary. The destination responds with an HTTP status code of `202 Accepted`, and an HTTP header containing a `Content-Location` parameter that specifies the URL at which status of the request will be available
- The intermediary passes through the response to the originator
- The originator receives the response
- The originator polls for status until the server responds with a "completed" HTTP status code 200 and body containing one or more URLs at which to retrieve the response data
- The originator retrieves the response data using the URL(s) returned in the completed status message from the destination

*[Exchange flows and additional details](specification.html#scenario-originator-initiates-an-asynchronous-retrieval-of-data-from-a-destination-that-uses-an-inbound-gateway-intermediary)*

<br/>

---

